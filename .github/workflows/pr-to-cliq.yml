name: GitHub Notifications to Zoho Cliq

on:
  pull_request:
    types: [opened, closed, review_requested]
  push:
    branches:
      - main

jobs:
  send-to-cliq:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # We need at least the current and previous commit
      
      - name: Send Event Notification to Cliq
        env:
          CLIQ_WEBHOOK_URL: https://cliq.zoho.com/company/779974041/api/v2/channelsbyname/prtocliq/message?zapikey=1001.eec9969393f54e023ffdb45647eab8bd.6468beb706a1b444bc9cf7502cf8d5a0
        run: |
          EVENT_TYPE=""
          TITLE=""
          URL=""
          AUTHOR=""
          MESSAGE=""

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            URL="${{ github.event.pull_request.html_url }}"
            TITLE="${{ github.event.pull_request.title }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"

            if [ "${{ github.event.action }}" == "opened" ]; then
              EVENT_TYPE="üöÄ New Pull Request Opened"
              MESSAGE="*${EVENT_TYPE}*\n*Title:* ${TITLE}\n*Author:* ${AUTHOR}\n*Link:* ${URL}"

            elif [ "${{ github.event.action }}" == "closed" ]; then
              if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
                EVENT_TYPE="‚úÖ Pull Request Merged"
                MERGED_BY="${{ github.event.pull_request.merged_by.login }}"
                MESSAGE="*${EVENT_TYPE}*\n*Title:* ${TITLE}\n*Author:* ${AUTHOR}\n*Merged By:* ${MERGED_BY}\n*Link:* ${URL}"
              else
                EVENT_TYPE="‚ùå Pull Request Closed Without Merge"
                MESSAGE="*${EVENT_TYPE}*\n*Title:* ${TITLE}\n*Author:* ${AUTHOR}\n*Link:* ${URL}"
              fi

            elif [ "${{ github.event.action }}" == "review_requested" ]; then
              EVENT_TYPE="üîé Review Requested on Pull Request"
              MESSAGE="*${EVENT_TYPE}*\n*Title:* ${TITLE}\n*Author:* ${AUTHOR}\n*Link:* ${URL}"
            else
              EVENT_TYPE="‚ÑπÔ∏è Unknown PR Event"
              MESSAGE="*${EVENT_TYPE}*\n*Title:* ${TITLE}\n*Author:* ${AUTHOR}\n*Link:* ${URL}"
            fi

          elif [ "${{ github.event_name }}" == "push" ]; then
            BRANCH_NAME="${{ github.ref }}"
            if [ "$BRANCH_NAME" == "refs/heads/main" ]; then
              COMMIT_MESSAGE=$(git log --format=%B -n 1 ${{ github.sha }})
              
              if ! echo "$COMMIT_MESSAGE" | grep -qE '\(#[0-9]+\)'; then
                PARENT_COUNT=$(git rev-list --count --parents -n 1 ${{ github.sha }} | awk '{print NF-1}')
                
                if [ "$PARENT_COUNT" -eq 1 ] || ! echo "$COMMIT_MESSAGE" | grep -qE 'Merge pull request #[0-9]+'; then
                  EVENT_TYPE="üö® Direct Push to Main Detected"
                  AUTHOR="${{ github.actor }}"
                  COMMIT_URL="https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
                  MESSAGE="*${EVENT_TYPE}*\n*Pushed By:* ${AUTHOR}\n*Commit:* ${COMMIT_URL}"
                fi
              fi
            fi
          fi

          if [ ! -z "$MESSAGE" ]; then
            curl -X POST "$CLIQ_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
                  \"text\": \"$MESSAGE\"
                }"
          fi